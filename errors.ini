# -*- encoding: utf-8 -*-

# Copyright 2013 Zack Weinberg <zackw@panix.com> and other contributors.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# There is NO WARRANTY.

# This file specifies errors.  "Errors", in this case, means a
# situation where a header fails to compile in isolation, and this is
# not correctable by either of the techniques offered in prereqs.ini.
# An error is not necessarily a bug; one of the most commonly
# encountered errors is that modern versions of GCC don't support
# <varargs.h>, but do so by shipping a stub header that
# unconditionally fails the compilation, rather than by omitting the
# header altogether.
#
# There is one section per error.  The section name is the codeword
# that will be written to the inventory as a $E line.  There are two
# required entries in each section: "regexp" specifies a regular
# expression used to detect the error, and "desc" is an HTML fragment
# that will be used to describe the error in the generated table (this
# should be a complete sentence).
#
# Regular expressions use the syntax understood by Python 2.0:
# http://docs.python.org/release/2.0/lib/re-syntax.html
#
# All regular expressions are compiled in VERBOSE mode, which means:
#
#   Whitespace within the pattern is ignored, except when in a
#   character class or preceded by an unescaped backslash, and, when a
#   line contains a "#" neither in a character class or preceded by an
#   unescaped backslash, all characters from the leftmost such "#"
#   through the end of the line are ignored.
#
# and then applied using re.search() to each individual line of the
# diagnostics, in isolation.  The first match wins.
#
# Most errors occur only in one specific header.  If you provide a
# "header" entry, its value is a space-separated list of headers, and
# the error will be considered only for those headers.
#
# Some errors are not complete showstoppers for use of a header.
# If a section is marked "caution = 1" then the error is considered
# nonfatal, unless it occurs in all test modes.

# generic problems
[legacy_type_decls]
caution = 1
regexp = \b(?:u_(?:char|short|int|long|quad_t|int(?:8|16|32|64)_t)
             |u(?:short|int|long)
             |quad_t|fsid_t|daddr_t|caddr_t)\b
desc =
  Uses legacy typedefs that <code>sys/types.h</code> does not provide
  in conformance mode.

# problems with specific headers
[varargs_unimpl]
header = varargs.h
regexp = \#error\b .* \bstdarg\.h\b
desc =
  Explicitly unimplemented: contains only an <code>#error</code> directive
  telling the programmer to use <code>stdarg.h</code> instead.

[malloc_unimpl]
header = malloc.h
regexp = \#error\b .* \bstdlib\.h\b
desc =
  Explicitly unimplemented: contains only an <code>#error</code> directive
  telling the programmer to use <code>stdlib.h</code> instead.

[ucontext_deprecated]
header = ucontext.h
regexp = \#error\b .* \bdeprecated\b
desc =
  This OS deprecates <code>ucontext.h</code> and issues an <code>#error</code>
  if it is used without defining <code>_XOPEN_SOURCE</code>.

[sys_dir_deprecated]
header = sys/dir.h
regexp = \#warning\b .* \bdirent\.h\b
desc =
  This obsolete header generates an unconditional <code>#warning</code>
  telling the programmer to use <code>dirent.h</code> instead.

[old_terminal_api_deprecated]
header = sys/termios.h sgtty.h
regexp = \#warning\b .* \btermios\.h\b
desc =
  This obsolete header generates an unconditional <code>#warning</code>
  telling the programmer to use <code>termios.h</code> instead.

[sys_timeb_deprecated]
header = sys/timeb.h
regexp = \#warning\b .* \bdeprecated\b
desc =
  This header generates an unconditional <code>#warning</code>s telling
  the programmer that it is obsolete.

[sys_socketvar_sotimeq_hash]
header = sys/socketvar.h
regexp = array\ type\ has\ incomplete\ element\ type
desc =
  Attempts to declare <code>extern struct sotimeq sotimeq_hash[];</code>
  with <code>struct sotimeq</code> an incomplete type; this is invalid.
  The necessary structure definition is immediately below the offending
  declaration.

[rpcsvc_mount_fhandle_t]
header = rpcsvc/mount.h
regexp = fhandle_t
desc =
  Contains declarations depending on a typedef, <code>fhandle_t</code>,
  which is only defined in what appear to be private kernel headers.
  Other OSes define this type in this header.

[regexp_return_makes_pointer]
header = regexp.h
regexp = return\ makes\ pointer\ from\ integer\ without\ a\ cast
desc =
  Incorrect use of <code>RETURN()</code> instead of <code>ERROR()</code>
  in the embedded code in this header.

[nameser_duplicate_members]
caution = 1
header = arpa/nameser_compat.h arpa/nameser.h resolv.h
regexp = duplicate\ member\ .(?:rd|tc|aa|opcode|qr|rcode|cd|ad|unused|ra)
desc =
  Structure definition depending on unprefixed <code>BYTE_ORDER</code>,
  which is not available in conformance mode.

[netinet_if_ether_ac_if_incomplete]
caution = 1
header = netinet/if_ether.h
regexp = \bincomplete\b.*\bac_if\b|\bac_if\b.*incomplete\b
desc =
  Structure definition depending on <code>struct ifnet</code>, which is
  provided by <code>net/if.h</code>, but unavailable in conformance mode.

[protocols_timed_MAXHOSTNAMELEN_unavailable]
caution = 1
header = protocols/timed.h
regexp = \bMAXHOSTNAMELEN\b
desc =
  Depends on the constant <code>MAXHOSTNAMELEN</code>, which is provided
  by <code>netdb.h</code>, but unavailable in conformance mode.

[sys_procfs_sigaltstack_unavailable]
caution = 1
header = sys/procfs.h
regexp = \bincomplete\b.*\bpr_altstack\b|\bpr_altstack\b.*\bincomplete\b
desc =
  Depends on <code>struct sigaltstack</code>, a compatibility name for
  <code>stack_t</code>, which is provided by <code>signal.h</code>, but
  unavailable in conformance mode.

[sys_socketvar_kfpu_or_label_t_unavailable]
header = sys/socketvar.h
regexp = \bkfpu_t\b|\blabel_t\b
caution = 1
desc =
  Indirectly depends on type definitions for <code>kfpu_t</code> and/or
  <code>label_t</code>, which are unavailable in conformance mode.

[sys_user_MAXSIG_unavailable]
caution = 1
header = sys/user.h
regexp = \bMAXSIG\b
desc =
  Depends on the constant <code>MAXSIG</code>, which is provided
  by <code>signal.h</code>, but unavailable in conformance mode.
